#!/usr/bin/env python2
# -*- coding: utf-8 -*-
"""
Created on Fri Feb 25 11:00:58 2022

@author: logancross
"""

from mvpa2.suite import *
import matplotlib.pyplot as plt
import pandas as pd
import seaborn as sns
import statsmodels

# statistical annotation
def annotate_stats(rect1):
    x1 = rect1.xy[0]+ (rect1.get_width() / 2)
    y1 = rect1.get_height() + 0.04
    plt.text(x1, y1, "*", ha='center', va='bottom', color='k')

#bundle_path = '/Users/logancross/Documents/Bundle_Value/'
bundle_path = '/Users/locro/Documents/Bundle_Value/'

#analysis_file = 'xdecode_rois.csv'
analysis_file = 'xdecode_rois_2023.csv'

save = False

subj_list = ['101','102','103','104','105','106','107','108','109','110','111','112','113','114']

mask_loop = ['ACC_pre','ACC_sup',
             'Frontal_Inf_Orb_2','Frontal_Med_Orb','OFCant','OFClat','OFCmed','OFCpost' ,
             'Frontal_Sup_Medial','Frontal_Sup_2','Frontal_Mid_2','Frontal_Inf_Tri']

mask_names = ['rACC','dACC',
              'vlPFC','vmPFC','OFCant','OFClat','OFCmed','OFCpost',
              'dmPFC','dlPFC','MFG','IFG']

subj_list = ['101','102','103','104','105','106','107','108','109','110','111','112','113','114']
subj = subj_list[0]
scores_df = pd.read_csv(bundle_path+'mvpa/analyses/sub'+str(subj)+'/'+analysis_file)
scores_df = scores_df.drop(columns=['Unnamed: 0'])

subj_count = 1
for subj in subj_list[1:]:
    temp_df = pd.read_csv(bundle_path+'mvpa/analyses/sub'+str(subj)+'/'+analysis_file)
    temp_df = temp_df.drop(columns=['Unnamed: 0'])
    scores_df = pd.concat([scores_df, temp_df], ignore_index=True)
    
df_plot = pd.melt(scores_df, id_vars=["Subj","Mask"], var_name="Decoding Type", value_name="Accuracy")

ax = sns.barplot(x="Mask", y="Accuracy", hue="Decoding Type", data=df_plot, ci=68)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
#ax = sns.barplot(x="Mask", y="Accuracy", hue="Decoding Type", data=df_plot, ci=None)
plt.xticks(rotation=90)
plt.legend(title='Decoding Type', bbox_to_anchor=(1.04,1), loc="upper left")
plt.title('Cross Decoding All Subjects')
plt.show()

#####################################
# Train on Single Items plot
df_plot_strain = df_plot[(df_plot['Decoding Type'] == 'S2S') + (df_plot['Decoding Type'] == 'S2B')]
df_plot_strain = df_plot_strain.reset_index(drop=True)

color={'S2S': 'tomato','S2B': 'dodgerblue'}

ax = sns.barplot(x="Mask", y="Accuracy", hue="Decoding Type", data=df_plot_strain, palette=color, ci=68)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
#ax = sns.barplot(x="Mask", y="Accuracy", hue="Decoding Type", data=df_plot, ci=None)
plt.xticks(rotation=90)
plt.ylim([0, 0.19])
h, l = ax.get_legend_handles_labels()
labels=['Single Item','Bundle']
ax.legend(h, labels, title='Test On', bbox_to_anchor=(1.04,1), loc="upper left")
plt.ylabel('Accuracy (Pearson r)', fontsize=14)
plt.xlabel('ROI', fontsize=16)
plt.title('Cross Decoding Value - Train on Single Items')

# statistical annotation
# test with nonparametric stats - wilcoxon signed rank
s2s_uncorr_pvals = []
s2b_uncorr_pvals = []
pair_uncorr_pvals = []
for mask_num,mask in enumerate(mask_names):
    mask_score_s2s = df_plot_strain.loc[(df_plot_strain['Mask'] == mask) & (df_plot_strain['Decoding Type'] == 'S2S')]['Accuracy'].values
    wilp_s2s = stats.wilcoxon(mask_score_s2s)[1]
    s2s_uncorr_pvals.append(wilp_s2s)
    mask_score_s2b = df_plot_strain.loc[(df_plot_strain['Mask'] == mask) & (df_plot_strain['Decoding Type'] == 'S2B')]['Accuracy'].values
    wilp_s2b = stats.wilcoxon(mask_score_s2b)[1]
    s2b_uncorr_pvals.append(wilp_s2b)
    paired_pval = stats.wilcoxon(mask_score_s2s, mask_score_s2b)[1]
    pair_uncorr_pvals.append(paired_pval)
    
# correct for multiple comparisons
# s2s
print '\nS2S'
sig_bools, s2s_corr_pvals, alphacSidak, alphacBonf = statsmodels.stats.multitest.multipletests(s2s_uncorr_pvals, alpha=0.05, method='fdr_bh')
for mask_num,sig in enumerate(sig_bools):
    mask = mask_names[mask_num]
    fdr_p = s2s_corr_pvals[mask_num]   
    if sig:
        print mask,' Significant S Train S Test',fdr_p
        annotate_stats(ax.patches[mask_num])
    else:
        print mask,' Not Significant S Train S Test',fdr_p
# s2b
print '\nS2B'
sig_bools, s2b_corr_pvals, alphacSidak, alphacBonf = statsmodels.stats.multitest.multipletests(s2b_uncorr_pvals, alpha=0.05, method='fdr_bh')       
for mask_num,sig in enumerate(sig_bools):
    mask = mask_names[mask_num]
    fdr_p = s2b_corr_pvals[mask_num]   
    if sig:
        print mask,' Significant S Train B Test',fdr_p
        annotate_stats(ax.patches[mask_num+12])
    else:
        print mask,' Not Significant S Train B Test',fdr_p      
        
# paired comparison
print '\nPairs'
sig_bools, pair_corr_pvals, alphacSidak, alphacBonf = statsmodels.stats.multitest.multipletests(pair_uncorr_pvals, alpha=0.05, method='fdr_bh') 
for mask_num,sig in enumerate(sig_bools):
    mask = mask_names[mask_num]
    fdr_p = pair_corr_pvals[mask_num]   
    if sig:
        print mask,' Significant Paired Diff',fdr_p
        #annotate_stats(ax.patches[mask_num+12])
    else:
        print mask,' Not Significant Paired Diff,fdr_p'     
if save:
    plt.savefig('/Users/logancross/Documents/Bundle_Value/figures/xdecode_roi_strain', dpi=500, bbox_inches='tight')
plt.show()
#####################################


#####################################
# Train on Bundles plot
df_plot_btrain = df_plot[(df_plot['Decoding Type'] == 'B2S') + (df_plot['Decoding Type'] == 'B2B')]
df_plot_btrain = df_plot_btrain.reset_index(drop=True)

color={'B2S': 'tomato','B2B': 'dodgerblue'}
hue_order = ['B2S','B2B']

ax = sns.barplot(x="Mask", y="Accuracy", hue="Decoding Type", data=df_plot_btrain, hue_order=hue_order, palette=color, ci=68)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
#ax = sns.barplot(x="Mask", y="Accuracy", hue="Decoding Type", data=df_plot, ci=None)
plt.xticks(rotation=90)
#plt.ylim([0, 0.22])
h, l = ax.get_legend_handles_labels()
labels=['Single Item','Bundle']
ax.legend(h, labels, title='Test On', bbox_to_anchor=(1.04,1), loc="upper left")
plt.ylabel('Accuracy (Pearson r)', fontsize=14)
plt.xlabel('ROI', fontsize=16)
plt.title('Cross Decoding Value - Train on Bundles')

# statistical annotation
# test with nonparametric stats - wilcoxon signed rank
b2s_uncorr_pvals = []
b2b_uncorr_pvals = []
pair_uncorr_pvals = []
for mask_num,mask in enumerate(mask_names):
    mask_score_b2s = df_plot_btrain.loc[(df_plot_btrain['Mask'] == mask) & (df_plot_btrain['Decoding Type'] == 'B2S')]['Accuracy'].values
    wilp_b2s = stats.wilcoxon(mask_score_b2s)[1]
    b2s_uncorr_pvals.append(wilp_b2s)
    mask_score_b2b = df_plot_btrain.loc[(df_plot_btrain['Mask'] == mask) & (df_plot_btrain['Decoding Type'] == 'B2B')]['Accuracy'].values
    wilp_b2b = stats.wilcoxon(mask_score_b2b)[1]
    b2b_uncorr_pvals.append(wilp_b2b)
    paired_pval = stats.wilcoxon(mask_score_b2s, mask_score_b2b)[1]
    pair_uncorr_pvals.append(paired_pval)
    
# correct for multiple comparisons
# b2s
print '\nB2S'
sig_bools, b2s_corr_pvals, alphacSidak, alphacBonf = statsmodels.stats.multitest.multipletests(b2s_uncorr_pvals, alpha=0.05, method='fdr_bh')
for mask_num,sig in enumerate(sig_bools):
    mask = mask_names[mask_num]
    fdr_p = b2s_corr_pvals[mask_num]   
    if sig:
        print mask,' Significant B Train S Test',fdr_p
        annotate_stats(ax.patches[mask_num])
    else:
        print mask,' Not Significant B Train S Test',fdr_p
# b2b
print '\nB2B'
sig_bools, b2b_corr_pvals, alphacSidak, alphacBonf = statsmodels.stats.multitest.multipletests(b2b_uncorr_pvals, alpha=0.05, method='fdr_bh')       
for mask_num,sig in enumerate(sig_bools):
    mask = mask_names[mask_num]
    fdr_p = b2b_corr_pvals[mask_num]   
    if sig:
        print mask,' Significant B Train B Test',fdr_p
        annotate_stats(ax.patches[mask_num+12])
    else:
        print mask,' Not Significant B Train B Test',fdr_p      
        
# paired comparison
print '\nPairs'
sig_bools, pair_corr_pvals, alphacSidak, alphacBonf = statsmodels.stats.multitest.multipletests(pair_uncorr_pvals, alpha=0.05, method='fdr_bh') 
for mask_num,sig in enumerate(sig_bools):
    mask = mask_names[mask_num]
    fdr_p = pair_corr_pvals[mask_num]   
    if sig:
        print mask,' Significant Paired Diff',fdr_p
        #annotate_stats(ax.patches[mask_num+12])
    else:
        print mask,' Not Significant Paired Diff',fdr_p  
if save:
    plt.savefig('/Users/logancross/Documents/Bundle_Value/figures/xdecode_roi_btrain', dpi=500, bbox_inches='tight')
plt.show()
#####################################